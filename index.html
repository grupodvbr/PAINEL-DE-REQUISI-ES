<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel de Requisi√ß√µes</title>

  <style>
    :root {
      --cor-fundo: #ffffff;
      --cor-texto: #000000;
      --cor-botao: #007bff;
      --cor-botao-vermelho: #dc3545;
      --cor-destaque: #007bff;
      --cor-cinza-claro: #f8f9fa;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: var(--cor-fundo);
      color: var(--cor-texto);
      font-family: Arial, sans-serif;
    }


    h1 {
      margin: 0;
      padding: 15px 0;
      color: var(--cor-texto);
      font-size: 1.6em;
    }

    .header-flex {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 20px;
      background: var(--cor-fundo);
      border-bottom: 1px solid #ccc;
    }

    .logo-area {
      flex: 1;
    }

    .titulo-area {
      flex: 1;
      text-align: center;
    }

    .espaco-direito {
      flex: 1;
    }

    .logo-area img {
      height: 50px;
      max-width: 150px;
      object-fit: contain;
    }

    .top-bar {
      background: var(--cor-fundo);
    }

    .botoes-acoes {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      padding: 10px 20px 0;
    }

    .botoes-acoes button {
      background: var(--cor-botao);
      color: white;
      border: none;
      padding: 8px 14px;
      font-size: 0.9em;
      border-radius: 6px;
      cursor: pointer;
    }

    .filtros {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 10px 20px;
      justify-content: space-between;
      background: var(--cor-cinza-claro);
      border-radius: 8px;
    }

    .filtros label {
  display: flex;
  flex-direction: column;
  font-size: 0.9em;
  min-width: 150px;
  flex: 1;
  font-weight: bold;
}
#filtroStatus {
  margin-left: 15px;
}


    .filtros input,
    .filtros select {
      padding: 10px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: white;
    }

    #btnFiltrar {
      padding: 10px 16px;
      background: var(--cor-botao);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1em;
      align-self: flex-end;
      height: 42px;
    }

    .btn-massa {
      background: white;
      color: black;
      border: 2px solid var(--cor-botao);
      padding: 10px 16px;
      border-radius: 8px;
      margin: 10px 20px;
      font-size: 1em;
      cursor: pointer;
      font-weight: bold;
    }

    .tabela-container {
      max-width: 98%;
      margin: 0 auto 20px;
      background: white;
      border-radius: 8px;
      overflow-x: auto;
      overflow-y: auto;
      max-height: calc(100vh - 260px); /* AJUSTADO AQUI */
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95em;
    }

    thead th {
      position: sticky;
      top: 0;
      background: var(--cor-botao);
      color: white;
      z-index: 10;
    }

    tbody tr:nth-child(even) { background: #f2f2f2; }
    tbody tr:nth-child(odd) { background: #ffffff; }
    tbody tr { border-bottom: 1px solid #ccc; }

    .acoes button {
      margin: 2px 4px;
      padding: 6px 10px;
      font-size: 0.85em;
      border: none;
      background: #6c757d;
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }

    .status-pendente {
      background: #fff3cd;
      color: #856404;
      font-weight: bold;
    }

    #modalAgrupar .box,
    #modalAgruparWhatsApp .box {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      width: 300px;
      text-align: center;
    }

    #modalAgrupar,
    #modalAgruparWhatsApp {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.4);
      justify-content: center;
      align-items: center;
      z-index: 999;
    }

   @media (max-width: 768px) {
  body {
    font-size: 0.95em;
  }

  .header-flex {
    flex-direction: column;
    gap: 10px;
    padding: 10px;
    text-align: center;
  }

  .logo-area, .espaco-direito {
    display: none;
  }

  .titulo-area {
    text-align: center;
  }

  .botoes-acoes {
    justify-content: center;
    flex-wrap: wrap;
    gap: 10px;
    padding: 10px;
  }

  .filtros {
    flex-direction: column;
    padding: 10px;
  }

  .filtros label {
    width: 100%;
    min-width: unset;
  }

  #btnFiltrar, .btn-massa {
    width: 100%;
    margin-top: 10px;
  }

  .tabela-container {
    max-height: none;
    overflow-x: scroll;
    padding-bottom: 100px;
  }

  table {
    font-size: 0.85em;
  }

  .acoes button {
    font-size: 0.75em;
    padding: 4px 6px;
  }
}


    table th:nth-child(2),
    table td:nth-child(2) {
      width: 300px !important;
      min-width: 300px !important;
      max-width: 300px !important;
      word-wrap: break-word !important;
      white-space: normal !important;
    }
    @media (max-width: 768px) {
  body {
    overflow: auto !important;
  }
}

  </style>

</head>

<body>

  <!-- ‚úÖ Cabe√ßalho com logo e t√≠tulo centralizado -->
  <div class="header-flex">
    <div class="logo-area">
      <img src="https://static.wixstatic.com/media/d830b0_8cec50a98bbf4775814dbfa5386585e8~mv2.png" alt="Logo" />
    </div>
    <div class="titulo-area">
      <h1>Painel de Requisi√ß√µes</h1>
    </div>
    <div class="espaco-direito"></div>
  </div>

  <div class="top-bar">
    <div class="botoes-acoes">
      <button onclick="abrirModalAgrupar('pdf')">üìö PDF</button>
      <button onclick="abrirModalAgruparWhatsApp()">üì± WhatsApp</button>
      <button onclick="abrirModalAgrupar('print')">üñ®Ô∏è Imprimir</button>
    </div>
    <div class="filtros">
      <label>Data de:<input type="date" id="filtroDataInicio"></label>
      <label>Hora Inicial:<input type="time" id="filtroHoraInicio"></label>
      <label>Data at√©:<input type="date" id="filtroDataFim"></label>
      <label>Hora Final:<input type="time" id="filtroHoraFim"></label>
      <label>Solicitante:<select id="filtroSolicitante"><option value="">Todos</option></select></label>
      <label>Setor:<select id="filtroSetor"><option value="">Todos</option></select></label>
      <label>Palavra-chave:<input type="text" id="filtroPalavra" placeholder="Buscar item ou observa√ß√£o"></label>
      <button id="btnFiltrar" onclick="filtrar()">üîç Filtrar</button>
    </div>

  <div style="margin-left: 20px; display: inline-block;">
  <label style="font-weight: bold; font-size: 0.9em;">
    Status:
    <select id="filtroStatus" onchange="filtrar()" style="padding: 10px; font-size: 1em; border-radius: 6px; border: 1px solid #ccc;">
      <option value="">TODOS</option>
     <option value="PENDENTE" selected>PENDENTE</option>
      <option value="Concluir">CONCLUIR</option>
      <option value="Negar">NEGADOS</option>
      <option value="Comprar">COMPRAR</option>
    </select>
  </label>
</div>

  </label>
 <button onclick="concluirEmMassa()" style="margin: 10px; padding: 8px 16px; background: #388e3c; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">
  ‚úÖ Conclus√£o em Massa
</button>

  </div>

  <div class="tabela-container">
    <table id="tabelaExport">
      <thead>
        <tr>
          <th>Data e Hora</th><th>Item</th><th>Qtd</th><th>Unidade</th><th>Setor</th><th>Solicitante</th><th>Observa√ß√µes</th><th>Status</th><th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="tabelaRequisicoes"></tbody>
    </table>
  </div>

  <div id="modalAgrupar">
    <div class="box">
      <h3>Como deseja agrupar?</h3>
      <select id="seletorAgrupamento">
  <option value="setor">Setor</option>
  <option value="solicitante">Solicitante</option>
  <option value="status">Status</option>
</select>
      <button onclick="confirmarAgrupamento()">OK</button>
      <button onclick="document.getElementById('modalAgrupar').style.display='none'">Cancelar</button>
    </div>
  </div>
  <div id="modalAgruparWhatsApp" style="display:none; position:fixed; top:0;left:0;right:0;bottom:0; background:rgba(0,0,0,0.4); justify-content:center; align-items:center; z-index:999;">
  <div class="box" style="background:#fff; padding:20px; border-radius:10px; width:300px; text-align:center;">
    <h3>Como deseja agrupar no WhatsApp?</h3>
    <select id="seletorAgrupamentoWhatsApp">
      <option value="setor">Setor</option>
      <option value="solicitante">Solicitante</option>
      <option value="status">Status</option>
    </select>
    <button onclick="confirmarAgrupamentoWhatsApp()">Enviar</button>
    <button onclick="document.getElementById('modalAgruparWhatsApp').style.display='none'">Cancelar</button>
  </div>
</div>





  <script>
  let requisicoes = [];
  let listaFiltrada = [];

  async function carregarDados() {
    const res = await fetch('https://script.google.com/macros/s/AKfycbzjVWXyGuwLDEfqNwgJppU2Yvo3_r_L7wbD1-AXfd3lztOUlq5zbKTQ0QCP7IknVae4TA/exec');
    const dados = await res.json();

    requisicoes = dados
      .map((l, idx) => ({
        linha: l.map(c => (c || '').toString().trim()),
        idx
      }))
      .sort((a, b) => new Date(a.linha[0]) - new Date(b.linha[0]));

    listaFiltrada = [...requisicoes];
    renderizarTabela(listaFiltrada);
    popularFiltros();
  }

  function renderizarTabela(lista) {
    const tabela = document.getElementById('tabelaRequisicoes');
    tabela.innerHTML = '';
    lista.forEach(({ linha, idx }) => {
      const tr = document.createElement('tr');
      const novaOrdem = [0, 1, 3, 2, 4, 5, 6, 7];
      novaOrdem.forEach(i => {
        const td = document.createElement('td');
        let valor = linha[i];
        if (i === 7 && valor.toLowerCase() === "processando") valor = "PENDENTE";

        td.innerHTML = i === 0
          ? new Date(linha[i]).toLocaleString('pt-BR')
          : i === 1
            ? `<strong>${linha[i]}</strong>`
            : valor;

        tr.appendChild(td);
      });

      const tdAcoes = document.createElement('td');
      tdAcoes.className = 'acoes';
      ['Concluir', 'Comprar', 'Negar'].forEach(acao => {
        const btn = document.createElement('button');
        btn.textContent = acao;
        btn.onclick = () => atualizarStatus(idx, acao);
        tdAcoes.appendChild(btn);
      });

      tr.appendChild(tdAcoes);
      tabela.appendChild(tr);
    });
  }

  function atualizarStatus(linhaIndex, novoStatus) {
    const dadosOriginais = requisicoes[linhaIndex].linha;

    const payload = {
      dataHoraOriginal: dadosOriginais[0],
      item: dadosOriginais[1],
      unidade: dadosOriginais[2],
      quantidade: dadosOriginais[3],
      setor: dadosOriginais[4],
      solicitante: dadosOriginais[5],
      observacoes: dadosOriginais[6],
      statusOriginal: dadosOriginais[7],
      novoStatus: novoStatus
    };

    fetch('https://script.google.com/macros/s/AKfycbxnuFAAJLiThcP99gpgk-EhHIJ2N2YOXjpi7jVROHq6ZqniAkcXlI2h8uj16oTQHsVWnQ/exec', {
      method: 'POST',
      body: JSON.stringify(payload),
      headers: { 'Content-Type': 'application/json' }
    })
    .then(() => {
      const btns = document.querySelectorAll(`tr:nth-child(${linhaIndex + 1}) .acoes button`);
      btns.forEach(btn => {
        btn.disabled = true;
        if (novoStatus === 'Concluir') btn.textContent = '‚úîÔ∏è Conclu√≠do';
        else if (novoStatus === 'Comprar') btn.textContent = 'üõí Enviado para compra';
        else if (novoStatus === 'Negar') btn.textContent = '‚ùå Negado';
      });
    })
    .catch(err => alert("Erro ao registrar: " + err));
  }

  function concluirEmMassa() {
    const pendentes = listaFiltrada
      .map((item, idx) => ({ item, idx }))
      .filter(({ item }) => {
        const status = item.linha[7].toLowerCase();
        return status === "processando" || status === "pendente";
      });

    if (pendentes.length === 0) {
      alert("Nenhuma requisi√ß√£o com status PENDENTE encontrada.");
      return;
    }

    const confirmacao = confirm(`Deseja marcar ${pendentes.length} requisi√ß√µes como CONCLU√çDAS?`);
    if (!confirmacao) return;

    pendentes.forEach(({ item, idx }) => {
      const dados = item.linha;

      const payload = {
        dataHoraOriginal: dados[0],
        item: dados[1],
        unidade: dados[2],
        quantidade: dados[3],
        setor: dados[4],
        solicitante: dados[5],
        observacoes: dados[6],
        statusOriginal: dados[7],
        novoStatus: "Concluir"
      };

      fetch('https://script.google.com/macros/s/AKfycbxnuFAAJLiThcP99gpgk-EhHIJ2N2YOXjpi7jVROHq6ZqniAkcXlI2h8uj16oTQHsVWnQ/exec', {
        method: 'POST',
        body: JSON.stringify(payload),
        headers: { 'Content-Type': 'application/json' }
      })
      .then(() => {
        const btns = document.querySelectorAll(`tr:nth-child(${idx + 1}) .acoes button`);
        btns.forEach(btn => {
          btn.disabled = true;
          btn.textContent = '‚úîÔ∏è Conclu√≠do';
        });
      })
      .catch(err => console.error("Erro em massa:", err));
    });
  }

  carregarDados();
</script>



</body>
</html>
