<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel de Requisi√ß√µes</title>

  <script>
  let requisicoes = [];
  let listaFiltrada = [];

  async function carregarDados() {
    const res = await fetch('https://script.google.com/macros/s/AKfycbz-SfG7skNM7eElBNJ0go6epBodOG1_O-472tEeB-Aup4Ruvw7NxhlNL3W25MBmw4fs/exec');
    const dados = await res.json();

    requisicoes = dados
      .map((l, idx) => ({
        linha: l.map(c => (c || '').toString().trim()),
        idx
      }))
      .sort((a, b) => new Date(a.linha[0]) - new Date(b.linha[0]));

    listaFiltrada = [...requisicoes];
    renderizarTabela(listaFiltrada);
    popularFiltros();
  }

  function renderizarTabela(lista) {
    const tabela = document.getElementById('tabelaRequisicoes');
    tabela.innerHTML = '';
    lista.forEach(({ linha, idx }) => {
      const tr = document.createElement('tr');
      const novaOrdem = [0, 1, 3, 2, 4, 5, 6, 7];
      novaOrdem.forEach(i => {
        const td = document.createElement('td');
        let valor = linha[i];
        if (i === 7 && valor.toLowerCase() === "processando") valor = "PENDENTE";

        td.innerHTML = i === 0
          ? new Date(linha[i]).toLocaleString('pt-BR')
          : i === 1
            ? `<strong>${linha[i]}</strong>`
            : valor;

        tr.appendChild(td);
      });

      const tdAcoes = document.createElement('td');
      tdAcoes.className = 'acoes';
      ['Concluir', 'Comprar', 'Negar'].forEach(acao => {
        const btn = document.createElement('button');
        btn.textContent = acao;
        btn.onclick = () => atualizarStatus(idx, acao);
        tdAcoes.appendChild(btn);
      });

      tr.appendChild(tdAcoes);
      tabela.appendChild(tr);
    });
  }

  function filtrar() {
    const status = document.getElementById('filtroStatus').value.toLowerCase();
    const inicioData = document.getElementById('filtroDataInicio').value;
    const fimData = document.getElementById('filtroDataFim').value;
    const inicioHora = document.getElementById('filtroHoraInicio').value;
    const fimHora = document.getElementById('filtroHoraFim').value;
    const solicitante = document.getElementById('filtroSolicitante').value.toLowerCase();
    const setor = document.getElementById('filtroSetor').value.toLowerCase();
    const palavra = document.getElementById('filtroPalavra').value.toLowerCase();

    listaFiltrada = requisicoes
      .filter(({ linha }) => {
        const dataHora = new Date(linha[0]);
        if (inicioData) {
          const dataInicio = new Date(`${inicioData}T${inicioHora || '00:00'}`);
          if (dataHora < dataInicio) return false;
        }
        if (fimData) {
          const dataFim = new Date(`${fimData}T${fimHora || '23:59'}`);
          if (dataHora > dataFim) return false;
        }
        if (status && status !== '') {
          const statusAtual = linha[7].toLowerCase() === "processando" ? "pendente" : linha[7].toLowerCase();
          if (statusAtual !== status) return false;
        }
        if (solicitante && !linha[5].toLowerCase().includes(solicitante)) return false;
        if (setor && !linha[4].toLowerCase().includes(setor)) return false;
        if (palavra) {
          const item = linha[1].toLowerCase();
          const obs = (linha[6] || '').toLowerCase();
          if (!item.includes(palavra) && !obs.includes(palavra)) return false;
        }
        return true;
      });

    renderizarTabela(listaFiltrada);
  }

  function popularFiltros() {
    const solicitantes = new Set();
    const setores = new Set();
    requisicoes.forEach(({ linha }) => {
      solicitantes.add(linha[5]);
      setores.add(linha[4]);
    });

    const solicitanteSelect = document.getElementById('filtroSolicitante');
    const setorSelect = document.getElementById('filtroSetor');

    solicitantes.forEach(nome => {
      const option = document.createElement('option');
      option.value = nome;
      option.textContent = nome;
      solicitanteSelect.appendChild(option);
    });

    setores.forEach(nome => {
      const option = document.createElement('option');
      option.value = nome;
      option.textContent = nome;
      setorSelect.appendChild(option);
    });
  }

  function agruparPor(campo, lista = requisicoes) {
    const agrupado = {};
    lista.forEach(({ linha }) => {
      let chave = '';
      if (campo === 'setor') chave = linha[4];
      else if (campo === 'solicitante') chave = linha[5];
      else if (campo === 'status') {
        const raw = linha[7].toLowerCase();
        chave = raw === "processando" ? "PENDENTE" : raw.toUpperCase();
      } else chave = 'Outro';

      if (!agrupado[chave]) agrupado[chave] = [];
      agrupado[chave].push(linha);
    });
    return agrupado;
  }

  function gerarHTMLAgrupado(agrupado, opcao) {
    const logoURL = "https://static.wixstatic.com/media/d830b0_8cec50a98bbf4775814dbfa5386585e8~mv2.png";
    let html = `
      <div style="display:flex; align-items:center; gap:15px; margin-bottom:20px;">
        <img src="${logoURL}" style="height:50px; max-width:150px;">
        <h2 style="margin:0;">Requisi√ß√µes agrupadas por ${opcao}</h2>
      </div>
    `;
    html += '<table border="1" cellspacing="0" cellpadding="5" style="width:100%; border-collapse:collapse">';
    html += '<thead><tr style="background:#00796b; color:white"><th>Data e Hora</th><th>Item</th><th>Qtd</th><th>Unidade</th><th>Setor</th><th>Solicitante</th><th>Observa√ß√µes</th><th>Status</th></tr></thead>';

    for (const grupo in agrupado) {
      html += `<tr><td colspan="8" style="font-weight:bold; background:#eee">${grupo}</td></tr>`;
      agrupado[grupo].forEach(l => {
        const data = new Date(l[0]).toLocaleString('pt-BR');
        html += `<tr>
          <td>${data}</td>
          <td><strong>${l[1]}</strong></td>
          <td>${l[3]}</td>
          <td>${l[2]}</td>
          <td>${l[4]}</td>
          <td>${l[5]}</td>
          <td>${l[6]}</td>
          <td>${l[7]}</td>
        </tr>`;
      });
    }

    html += '</table>';
    return html;
  }

  function gerarPDFAgrupado(opcao) {
    const agrupado = agruparPor(opcao, listaFiltrada.length ? listaFiltrada.map(x => ({ linha: x.linha })) : requisicoes);
    const html = gerarHTMLAgrupado(agrupado, opcao);
    const container = document.createElement('div');
    container.innerHTML = html;
    html2pdf().from(container).set({ filename: 'requisicoes_agrupadas.pdf' }).save();
  }

  function imprimirAgrupado(opcao) {
    const agrupado = agruparPor(opcao, listaFiltrada.length ? listaFiltrada.map(x => ({ linha: x.linha })) : requisicoes);
    const html = gerarHTMLAgrupado(agrupado, opcao);
    const janela = window.open('', '_blank');
    janela.document.write(`<html><head><title>Impress√£o</title></head><body>${html}</body></html>`);
    janela.document.close();
    janela.print();
  }

  function enviarWhatsApp(criterio = 'setor') {
    const hoje = new Date();
    const dataFormatada = hoje.toLocaleDateString('pt-BR');
    const titulo = `**COMPRAS DEL√çCIA GOURMET - ${dataFormatada}**\n\n`;

    const agrupado = {};
    const fonte = listaFiltrada.length ? listaFiltrada : requisicoes;

    fonte.forEach(({ linha }) => {
      let chave = '';
      if (criterio === 'setor') chave = linha[4];
      else if (criterio === 'solicitante') chave = linha[5];
      else if (criterio === 'status') {
        const raw = linha[7].toLowerCase();
        chave = raw === "processando" ? "PENDENTE" : raw.toUpperCase();
      } else chave = 'Outro';

      const item = linha[1];
      const unidade = linha[2];
      const quantidade = linha[3];

      if (!agrupado[chave]) agrupado[chave] = [];
      agrupado[chave].push({ item, quantidade, unidade });
    });

    let mensagem = titulo;
    for (const grupo in agrupado) {
      mensagem += `üõí *${grupo}*\n`;
      agrupado[grupo].forEach(({ item, quantidade, unidade }) => {
        mensagem += `- ${item} ‚Äî ${quantidade} ${unidade}\n`;
      });
      mensagem += `\n`;
    }

    const link = `https://wa.me/?text=${encodeURIComponent(mensagem)}`;
    window.open(link, '_blank');
  }

  function abrirModalAgrupar(origem) {
    const modal = document.getElementById("modalAgrupar");
    modal.dataset.origem = origem;
    modal.style.display = "flex";
  }

  function confirmarAgrupamento() {
    const opcao = document.getElementById("seletorAgrupamento").value;
    const origem = document.getElementById("modalAgrupar").dataset.origem;
    document.getElementById("modalAgrupar").style.display = "none";
    if (origem === "pdf") gerarPDFAgrupado(opcao);
    else imprimirAgrupado(opcao);
  }

  function abrirModalAgruparWhatsApp() {
    document.getElementById("modalAgruparWhatsApp").style.display = "flex";
  }

  function confirmarAgrupamentoWhatsApp() {
    const criterio = document.getElementById("seletorAgrupamentoWhatsApp").value;
    document.getElementById("modalAgruparWhatsApp").style.display = "none";
    enviarWhatsApp(criterio);
  }

  function atualizarStatus(linhaIndex, novoStatus) {
    fetch('https://script.google.com/macros/s/AKfycbzgt3a_WkSea-tNEE3u2UgsxPOLdo2gP45gtRUcT8-DMO6THqW_P1ShhsXTVhBSCIN8/exec', {
      method: 'POST',
      body: JSON.stringify({ linha: linhaIndex, status: novoStatus }),
      headers: { 'Content-Type': 'application/json' }
    })
      .then(r => r.text())
      .then(res => {
        alert(res);
        carregarDados();
      })
      .catch(err => {
        console.error("Erro ao atualizar:", err);
        alert("Erro ao atualizar status: " + err);
      });
  }

  carregarDados();
</script>


</head>

<body>

  <!-- ‚úÖ Cabe√ßalho com logo e t√≠tulo centralizado -->
  <div class="header-flex">
    <div class="logo-area">
      <img src="https://static.wixstatic.com/media/d830b0_8cec50a98bbf4775814dbfa5386585e8~mv2.png" alt="Logo" />
    </div>
    <div class="titulo-area">
      <h1>Painel de Requisi√ß√µes</h1>
    </div>
    <div class="espaco-direito"></div>
  </div>

  <div class="top-bar">
    <div class="botoes-acoes">
      <button onclick="abrirModalAgrupar('pdf')">üìö PDF</button>
      <button onclick="abrirModalAgruparWhatsApp()">üì± WhatsApp</button>
      <button onclick="abrirModalAgrupar('print')">üñ®Ô∏è Imprimir</button>
    </div>
    <div class="filtros">
      <label>Data de:<input type="date" id="filtroDataInicio"></label>
      <label>Hora Inicial:<input type="time" id="filtroHoraInicio"></label>
      <label>Data at√©:<input type="date" id="filtroDataFim"></label>
      <label>Hora Final:<input type="time" id="filtroHoraFim"></label>
      <label>Solicitante:<select id="filtroSolicitante"><option value="">Todos</option></select></label>
      <label>Setor:<select id="filtroSetor"><option value="">Todos</option></select></label>
      <label>Palavra-chave:<input type="text" id="filtroPalavra" placeholder="Buscar item ou observa√ß√£o"></label>
      <button id="btnFiltrar" onclick="filtrar()">üîç Filtrar</button>
    </div>

  <div style="margin-left: 20px; display: inline-block;">
  <label style="font-weight: bold; font-size: 0.9em;">
    Status:
    <select id="filtroStatus" onchange="filtrar()" style="padding: 10px; font-size: 1em; border-radius: 6px; border: 1px solid #ccc;">
      <option value="">TODOS</option>
     <option value="PENDENTE" selected>PENDENTE</option>
      <option value="Concluir">CONCLUIR</option>
      <option value="Negar">NEGADOS</option>
      <option value="Comprar">COMPRAR</option>
    </select>
  </label>
</div>

  </label>
    <button class="btn-massa" onclick="concluirEmMassa()">‚úÖ Conclus√£o em Massa</button>
  </div>

  <div class="tabela-container">
    <table id="tabelaExport">
      <thead>
        <tr>
          <th>Data e Hora</th><th>Item</th><th>Qtd</th><th>Unidade</th><th>Setor</th><th>Solicitante</th><th>Observa√ß√µes</th><th>Status</th><th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="tabelaRequisicoes"></tbody>
    </table>
  </div>

  <div id="modalAgrupar">
    <div class="box">
      <h3>Como deseja agrupar?</h3>
      <select id="seletorAgrupamento">
  <option value="setor">Setor</option>
  <option value="solicitante">Solicitante</option>
  <option value="status">Status</option>
</select>
      <button onclick="confirmarAgrupamento()">OK</button>
      <button onclick="document.getElementById('modalAgrupar').style.display='none'">Cancelar</button>
    </div>
  </div>
  <div id="modalAgruparWhatsApp" style="display:none; position:fixed; top:0;left:0;right:0;bottom:0; background:rgba(0,0,0,0.4); justify-content:center; align-items:center; z-index:999;">
  <div class="box" style="background:#fff; padding:20px; border-radius:10px; width:300px; text-align:center;">
    <h3>Como deseja agrupar no WhatsApp?</h3>
    <select id="seletorAgrupamentoWhatsApp">
      <option value="setor">Setor</option>
      <option value="solicitante">Solicitante</option>
      <option value="status">Status</option>
    </select>
    <button onclick="confirmarAgrupamentoWhatsApp()">Enviar</button>
    <button onclick="document.getElementById('modalAgruparWhatsApp').style.display='none'">Cancelar</button>
  </div>
</div>





  <script>
  let requisicoes = [];
  let listaFiltrada = [];

async function carregarDados() {
  const res = await fetch('https://script.google.com/macros/s/AKfycbz-SfG7skNM7eElBNJ0go6epBodOG1_O-472tEeB-Aup4Ruvw7NxhlNL3W25MBmw4fs/exec');
  const dados = await res.json();

  requisicoes = dados
    .map((l, idx) => ({ linha: l.map(c => (c || '').toString().trim()), idx }))
    .sort((a, b) => new Date(a.linha[0]) - new Date(b.linha[0])); // ordena√ß√£o por data

  listaFiltrada = [...requisicoes]; // mostra tudo
  renderizarTabela(listaFiltrada);
  popularFiltros();
}


  function renderizarTabela(lista) {
  const tabela = document.getElementById('tabelaRequisicoes');
  tabela.innerHTML = '';
  lista.forEach(({ linha, idx }) => {
    const tr = document.createElement('tr');
    const novaOrdem = [0, 1, 3, 2, 4, 5, 6, 7];
    novaOrdem.forEach(i => {
  const td = document.createElement('td');

  let valor = linha[i];
  if (i === 7 && valor.toLowerCase() === "processando") valor = "PENDENTE";

  td.innerHTML = i === 0
    ? new Date(linha[i]).toLocaleString('pt-BR')
    : i === 1
    ? `<strong>${linha[i]}</strong>`
    : valor;

  tr.appendChild(td);
});

    const tdAcoes = document.createElement('td');
    tdAcoes.className = 'acoes';

    ['Concluir', 'Comprar', 'Negar'].forEach(acao => {
      const btn = document.createElement('button');
      btn.textContent = acao;
      btn.onclick = () => atualizarStatus(idx, acao);
      tdAcoes.appendChild(btn);
    });

    tr.appendChild(tdAcoes);
    tabela.appendChild(tr);
  });
}


  function filtrar() {
    const status = document.getElementById('filtroStatus').value.toLowerCase();
    const inicioData = document.getElementById('filtroDataInicio').value;
    const fimData = document.getElementById('filtroDataFim').value;
    const inicioHora = document.getElementById('filtroHoraInicio').value;
    const fimHora = document.getElementById('filtroHoraFim').value;
    const solicitante = document.getElementById('filtroSolicitante').value.toLowerCase();
    const setor = document.getElementById('filtroSetor').value.toLowerCase();
    const palavra = document.getElementById('filtroPalavra').value.toLowerCase();

    listaFiltrada = requisicoes
      .map((linha, idx) => ({ linha, idx }))
      .filter(({ linha }) => {
        const dataHora = new Date(linha[0]);
        if (inicioData) {
          const dataInicio = new Date(`${inicioData}T${inicioHora || '00:00'}`);
          if (dataHora < dataInicio) return false;
        }
        if (fimData) {
          const dataFim = new Date(`${fimData}T${fimHora || '23:59'}`);
          if (dataHora > dataFim) return false;
        }
        if (status && status !== '') {
  const statusAtual = linha[7].toLowerCase() === "processando" ? "pendente" : linha[7].toLowerCase();
  if (statusAtual !== status.toLowerCase()) return false;
}


        if (solicitante && !linha[5].toLowerCase().includes(solicitante)) return false;
        if (setor && !linha[4].toLowerCase().includes(setor)) return false;
        if (palavra) {
          const item = linha[1].toLowerCase();
          const obs = (linha[6] || '').toLowerCase();
          if (!item.includes(palavra) && !obs.includes(palavra)) return false;
        }
        return true;
      });

    renderizarTabela(listaFiltrada);
  }

  function popularFiltros() {
    const solicitantes = new Set();
    const setores = new Set();
    requisicoes.forEach(l => {
      solicitantes.add(l[5]);
      setores.add(l[4]);
    });

    const solicitanteSelect = document.getElementById('filtroSolicitante');
    const setorSelect = document.getElementById('filtroSetor');

    solicitantes.forEach(nome => {
      const option = document.createElement('option');
      option.value = nome;
      option.textContent = nome;
      solicitanteSelect.appendChild(option);
    });

    setores.forEach(nome => {
      const option = document.createElement('option');
      option.value = nome;
      option.textContent = nome;
      setorSelect.appendChild(option);
    });
  }

  function abrirModalAgrupar(origem) {
    const modal = document.getElementById("modalAgrupar");
    modal.dataset.origem = origem;
    modal.style.display = "flex";
  }

  function confirmarAgrupamento() {
    const opcao = document.getElementById("seletorAgrupamento").value;
    const origem = document.getElementById("modalAgrupar").dataset.origem;
    document.getElementById("modalAgrupar").style.display = "none";
    if (origem === "pdf") gerarPDFAgrupado(opcao);
    else imprimirAgrupado(opcao);
  }

  function agruparPor(campo, lista = requisicoes) {
  const agrupado = {};
  lista.forEach(l => {
    let chave = '';
    if (campo === 'setor') chave = l[4];
    else if (campo === 'solicitante') chave = l[5];
    else if (campo === 'status') chave = l[7].toLowerCase() === "processando" ? "PENDENTE" : l[7];
    else chave = 'Outro';

    if (!agrupado[chave]) agrupado[chave] = [];
    agrupado[chave].push(l);
  });
  return agrupado;
}


  function gerarHTMLAgrupado(agrupado, opcao) {
  // üîΩ Substitua a URL abaixo pela URL da sua imagem
  const logoURL = "https://static.wixstatic.com/media/d830b0_8cec50a98bbf4775814dbfa5386585e8~mv2.png";

  let html = `
    <div style="display:flex; align-items:center; gap:15px; margin-bottom:20px;">
      <img src="${logoURL}" style="height:50px; max-width:150px;">
      <h2 style="margin:0;">Requisi√ß√µes agrupadas por ${opcao}</h2>
    </div>
  `;

  html += '<table border="1" cellspacing="0" cellpadding="5" style="width:100%; border-collapse:collapse">';
  html += '<thead><tr style="background:#00796b; color:white"><th>Data e Hora</th><th>Item</th><th>Qtd</th><th>Unidade</th><th>Setor</th><th>Solicitante</th><th>Observa√ß√µes</th><th>Status</th></tr></thead>';

  for (const grupo in agrupado) {
    html += `<tr><td colspan="8" style="font-weight:bold; background:#eee">${grupo}</td></tr>`;
    agrupado[grupo].forEach(l => {
      const data = new Date(l[0]).toLocaleString('pt-BR');
      html += `<tr>
        <td>${data}</td>
        <td><strong>${l[1]}</strong></td>
        <td>${l[3]}</td>
        <td>${l[2]}</td>
        <td>${l[4]}</td>
        <td>${l[5]}</td>
        <td>${l[6]}</td>
        <td>${l[7]}</td>
      </tr>`;
    });
  }

  html += '</table>';
  return html;
}


  function gerarPDFAgrupado(opcao) {
    const agrupado = agruparPor(opcao, listaFiltrada.length ? listaFiltrada.map(x => x.linha) : requisicoes);

    const html = gerarHTMLAgrupado(agrupado, opcao);
    const container = document.createElement('div');
    container.innerHTML = html;
    html2pdf().from(container).set({ filename: 'requisicoes_agrupadas.pdf' }).save();
  }

  function imprimirAgrupado(opcao) {
   const agrupado = agruparPor(opcao, listaFiltrada.length ? listaFiltrada.map(x => x.linha) : requisicoes);
    const html = gerarHTMLAgrupado(agrupado, opcao);
    const janela = window.open('', '_blank');
    janela.document.write(`<html><head><title>Impress√£o</title></head><body>${html}</body></html>`);
    janela.document.close();
    janela.print();
  }

  function enviarWhatsApp(criterio = 'setor') {
    const hoje = new Date();
    const dataFormatada = hoje.toLocaleDateString('pt-BR');
    const titulo = `**COMPRAS DEL√çCIA GOURMET - ${dataFormatada}**\n\n`;

    const agrupado = {};
    const fonte = listaFiltrada.length ? listaFiltrada : requisicoes.map((linha, idx) => ({ linha, idx }));

    fonte.forEach(({ linha }) => {
      let chave = '';
      if (criterio === 'setor') chave = linha[4];
      else if (criterio === 'solicitante') chave = linha[5];
else if (criterio === 'status') {
  chave = linha[7].toLowerCase() === "processando" ? "PENDENTE" : linha[7];
}

      else chave = 'Outro';

      const item = linha[1];
      const unidade = linha[2];
      const quantidade = linha[3];

      if (!agrupado[chave]) agrupado[chave] = [];
      agrupado[chave].push({ item, quantidade, unidade });
    });

    let mensagem = titulo;
    for (const grupo in agrupado) {
      mensagem += `üõí *${grupo}*\n`;
      agrupado[grupo].forEach(({ item, quantidade, unidade }) => {
        mensagem += `- ${item} ‚Äî ${quantidade} ${unidade}\n`;
      });
      mensagem += `\n`;
    }

    const link = `https://wa.me/?text=${encodeURIComponent(mensagem)}`;
    window.open(link, '_blank');
  }

  function abrirModalAgruparWhatsApp() {
    document.getElementById("modalAgruparWhatsApp").style.display = "flex";
  }

  function confirmarAgrupamentoWhatsApp() {
    const criterio = document.getElementById("seletorAgrupamentoWhatsApp").value;
    document.getElementById("modalAgruparWhatsApp").style.display = "none";
    enviarWhatsApp(criterio);
  }
    function atualizarStatus(linhaIndex, novoStatus) {
  fetch('https://script.google.com/macros/s/AKfycbzgt3a_WkSea-tNEE3u2UgsxPOLdo2gP45gtRUcT8-DMO6THqW_P1ShhsXTVhBSCIN8/exec', {
  method: 'POST',
  body: JSON.stringify({ linha: linhaIndex, status: novoStatus }),
  headers: { 'Content-Type': 'application/json' }
})
  .then(r => r.text())
  .then(res => {
    alert(res);
    carregarDados(); // recarrega os dados atualizados
  })
  .catch(err => {
    console.error("Erro ao atualizar:", err);
    alert("Erro ao atualizar status: " + err);
  });
}



  carregarDados();
</script>

</body>
</html>
